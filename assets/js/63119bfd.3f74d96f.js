"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2839],{817:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"high_assurance/relying_party/authentication","title":"Authentication","description":"This section covers authentication for a high assurance scenario.","source":"@site/docs/high_assurance/relying_party/authentication.md","sourceDirName":"high_assurance/relying_party","slug":"/high_assurance/relying_party/authentication","permalink":"/passkey-workshop/docs/high_assurance/relying_party/authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/YubicoLabs/passkey-workshop/tree/main/docs/docs/high_assurance/relying_party/authentication.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Registration","permalink":"/passkey-workshop/docs/high_assurance/relying_party/registration"},"next":{"title":"Banking Application","permalink":"/passkey-workshop/docs/high_assurance/relying_party/banking_api"}}');var s=t(2467),a=t(8453);const r={sidebar_position:3},o="Authentication",c={},l=[{value:"API",id:"api",level:2},{value:"Data Sources",id:"data-sources",level:2},{value:"Authentication flow",id:"authentication-flow",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"authentication",children:"Authentication"})}),"\n",(0,s.jsx)(n.p,{children:"This section covers authentication for a high assurance scenario."}),"\n",(0,s.jsxs)(n.p,{children:["When signing in with a passkey, we want to use this credential's ",(0,s.jsx)(n.code,{children:"isHighAssurance"})," property to define a Level of Assurance (LoA) for the authentication event.\nThis LoA is then returned to the banking application to enforce its policy for authorizing transactions."]}),"\n",(0,s.jsxs)(n.p,{children:["In our architecture, authentication is performed by the OpenID Connect Provider, a role performed by Keycloak.\nAs explained in the ",(0,s.jsx)(n.a,{href:"/docs/high_assurance/architecture",children:"Architecture section"}),", Keycloak supports ACR claims to convey information\nabout the strength of the mechanism used for authenticating the user.\nWe will use the ",(0,s.jsx)(n.code,{children:"isHighAssurance"})," property of credentials stored during registration to return this LoA during authentication.\nThis of course requires another couple of changes to our Relying Party implementation, as well as to passkey authentication module used by KeyCloak."]}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,s.jsxs)(n.p,{children:["Let's first look at the definition of our passkey API, in particular the ",(0,s.jsx)(n.code,{children:"/assertion/result"})," method."]}),"\n",(0,s.jsxs)(n.p,{children:["Before, this method's ",(0,s.jsx)(n.a,{href:"/docs/relying-party/auth-flow#response-1",children:"response"})," simply returned a ",(0,s.jsx)(n.code,{children:"status"})," to denote the result of the authentication ceremony.\nNow, we need to extend this response to also include the LoA we assigned to this authentication ceremony, determined by the properties of the credential used during authentication."]}),"\n",(0,s.jsxs)(n.p,{children:["For instance, when authenticating with a passkey that was assigned a high assurance level, the value ",(0,s.jsx)(n.code,{children:"2"})," is returned in an ",(0,s.jsx)(n.code,{children:"loa"})," response property:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "status": "ok",\n  "loa": "2"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Here, ",(0,s.jsx)(n.code,{children:"1"})," indicates a low LoA, and ",(0,s.jsx)(n.code,{children:"2"})," indicates a high LoA.\nWe capture this in the following enum Type:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'  public enum loaEnum {\n    HIGH(2),\n    LOW(1);\n\n    private int value;\n\n    loaEnum(int value) {\n      this.value = value;\n    }\n\n    @JsonValue\n    public int getValue() {\n      return value;\n    }\n\n    @Override\n    public String toString() {\n      return String.valueOf(value);\n    }\n\n    @JsonCreator\n    public static loaEnum fromValue(int value) {\n      for (loaEnum b : loaEnum.values()) {\n        if (b.value == value) {\n          return b;\n        }\n      }\n      throw new IllegalArgumentException("Unexpected value \'" + value + "\'");\n    }\n\n  }\n'})}),"\n",(0,s.jsx)(n.h2,{id:"data-sources",children:"Data Sources"}),"\n",(0,s.jsx)(n.p,{children:"We do not need any changes to our Data Sources - everything we need is already covered with registration."}),"\n",(0,s.jsx)(n.h2,{id:"authentication-flow",children:"Authentication flow"}),"\n",(0,s.jsxs)(n.p,{children:["We do need to extend the implementation of the Authentication flow that was discussed in our earlier section on ",(0,s.jsx)(n.a,{href:"/docs/relying-party/auth-flow#implementation-1",children:"Authentication flows"}),".\nFortunately, the changes are trivial: we just need to retrieve the ",(0,s.jsx)(n.code,{children:"isHighAssurance"})," status of the credential used, and translate that to an ",(0,s.jsx)(n.code,{children:"loa"})," response property:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public AssertionResultResponse assertionResponse(AssertionResultRequest response) throws Exception {\n\n    ...\n\n        CredentialRegistration usedCredentialRegistration = relyingPartyInstance.getStorageInstance()\n            .getCredentialStorage().getByCredentialId(result.getCredential().getCredentialId()).stream().findFirst()\n            .get();\n\n        loaEnum resultLoa = usedCredentialRegistration.isHighAssurance() ? loaEnum.HIGH : loaEnum.LOW;\n\n        return AssertionResultResponse.builder().status("ok").loa(resultLoa).build();\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Keycloak will use the ",(0,s.jsx)(n.code,{children:"loa"})," value returned by the ",(0,s.jsx)(n.code,{children:"/assertion/result"})," method in its authentication module to create the ",(0,s.jsx)(n.code,{children:"acr"})," value.\nThis is rather specific to Keycloak, but for completeness, this is implemented using Keycloak's ",(0,s.jsx)(n.code,{children:"AuthenticationFlowContext"})," and ",(0,s.jsx)(n.code,{children:"AcrStore"})," classes:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"        AcrStore acrStore = new AcrStore(context.getAuthenticationSession());\n        acrStore.setLevelAuthenticated(assertionResponse.getLoa());\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(6540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);