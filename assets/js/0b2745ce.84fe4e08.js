"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2429],{6583:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"high_assurance/relying_party/banking_api","title":"Banking Application","description":"This section covers an example of a protected API for a high assurance scenario.","source":"@site/docs/high_assurance/relying_party/banking_api.md","sourceDirName":"high_assurance/relying_party","slug":"/high_assurance/relying_party/banking_api","permalink":"/passkey-workshop/docs/high_assurance/relying_party/banking_api","draft":false,"unlisted":false,"editUrl":"https://github.com/YubicoLabs/passkey-workshop/tree/main/docs/docs/high_assurance/relying_party/banking_api.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Authentication","permalink":"/passkey-workshop/docs/high_assurance/relying_party/authentication"},"next":{"title":"Advanced Protection","permalink":"/passkey-workshop/docs/high_assurance/relying_party/advanced_protection"}}');var r=t(2467),a=t(8453);const s={sidebar_position:4},o="Banking Application",c={},h=[{value:"API",id:"api",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"banking-application",children:"Banking Application"})}),"\n",(0,r.jsx)(n.p,{children:"This section covers an example of a protected API for a high assurance scenario."}),"\n",(0,r.jsx)(n.h1,{id:"transactions",children:"Transactions"}),"\n",(0,r.jsxs)(n.p,{children:["As explained in the ",(0,r.jsx)(n.a,{href:"/docs/high_assurance/architecture",children:"Architecture section"}),", the banking API (or the OAuth2 Resource Server as it is also called)\ncan use the ACR value to determine the Level of Assurance associated with the authentication ceremony in order to implement a policy for authorizing bank transactions."]}),"\n",(0,r.jsxs)(n.p,{children:["Just like our WebAuthn Relying Party application, the banking API is implemented using ",(0,r.jsx)(n.a,{href:"https://spring.io/projects/spring-boot",children:"Spring Boot"}),".\nThis means we do not need to implement any OAuth2 flows, as they are available as a module in ",(0,r.jsx)(n.a,{href:"https://spring.io/projects/spring-security",children:"Spring Security"}),".\nBest of all, an OAuth2 Resource Server can be implemented very easily with ",(0,r.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/jwt.html#oauth2resourceserver-jwt-minimalconfiguration",children:"minimal configuration"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["We simply point to our Keycloak instance using the following configuration file in our Spring Boot ",(0,r.jsx)(n.code,{children:"application.properties"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spring:\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          jwk-set-uri: http://localhost:8081/realms/BankApp/protocol/openid-connect/certs\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The access tokens issued by our OAuth2 Authorization Server are self-contained JWT tokens.\nThe ",(0,r.jsx)(n.code,{children:"jwk-set-uri"})," points to the keys required to verify these JWT tokens."]}),"\n",(0,r.jsx)(n.p,{children:"Next, we can set a custom JWT configuration.\nHere, we will require an access token for any requests to our banking API."}),"\n",(0,r.jsx)(n.p,{children:"For instance:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Configuration\n@EnableWebSecurity\npublic class ResourceServerSecurityConfiguration {\n\n        @Value("${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}")\n        String jwkSetUri;\n\n        @Bean\n        public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n                // @formatter:off\n                http\n                .authorizeHttpRequests((authorize) -> authorize\n                                .antMatchers("/v1/status").permitAll()\n                                .antMatchers("/v1/**").authenticated()\n                                .anyRequest().permitAll()\n                )\n                .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);\n                // @formatter:on\n                http.cors();    // bypass authorization checks for preflight checks\n                return http.build();\n        }\n\n        @Bean\n        JwtDecoder jwtDecoder() {\n                return NimbusJwtDecoder.withJwkSetUri(this.jwkSetUri).build();\n        }\n\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,r.jsxs)(n.p,{children:["The banking API is kept very simple.\nIf you deployed the banking application on ",(0,r.jsx)(n.code,{children:"localhost"}),", you can find its OpenAPI definition ",(0,r.jsx)(n.a,{href:"http://localhost:8082/",children:"here"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["All API methods require an OAuth2 access token for authorization.\nSome API calls require an access token with an ",(0,r.jsx)(n.code,{children:"acr"})," claim indicating that authentication was performed with a passkey on a high assurance level.\nMost is the case with the ",(0,r.jsx)(n.code,{children:"/account/{accountId}/transactions"})," method, where transactions involving a transfer of low amounts of money can be performed\nwith any LoA, but transactions involving more that $1000 must be authorized with a high LoA."]}),"\n",(0,r.jsxs)(n.p,{children:["The ACR value is extracted from the JWT token with the ",(0,r.jsx)(n.code,{children:"getAcr()"})," method defined in the API controller:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'    private int getAcr() {\n        JwtAuthenticationToken token = (JwtAuthenticationToken) SecurityContextHolder.getContext()\n                .getAuthentication();\n        Jwt jwt = (Jwt) token.getCredentials();\n        return Integer.parseInt((String) jwt.getClaims().get("acr"));\n    }\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"When extracting claims from JWT tokens, it is important that the token's signature has been verified.\nIn our implementation, this is performed automatically using the Spring Security module."})}),"\n",(0,r.jsxs)(n.p,{children:["The check for the current assurance level is implemented in the ",(0,r.jsx)(n.code,{children:"createTransaction()"})," method as follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'  public TransactionCreateResponse createTransaction(\n    int acr, String type, double amount, String description, String userhandle) throws Exception {\n\n    ...\n\n    if (amount >= 1000 && acr < 2) {\n      throw new AuthenticationException("User does not have the correct permissions. Please reauthenticate");\n    }\n\n    ...\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The generated ",(0,r.jsx)(n.code,{children:"AuthenticationException"})," will result in an HTTP response error with status 401 (",(0,r.jsx)(n.code,{children:"Unauthorized"}),"),\nand the required level of assurance (",(0,r.jsx)(n.code,{children:'acr_values="2"'}),"),\nafter which the client is expected to obtain a new access token with the higher LoA."]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var i=t(6540);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);