"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[767],{1520:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"high_assurance/relying_party/registration","title":"Registration","description":"This section covers registration for a high assurance scenario.","source":"@site/docs/high_assurance/relying_party/registration.md","sourceDirName":"high_assurance/relying_party","slug":"/high_assurance/relying_party/registration","permalink":"/passkey-workshop/docs/high_assurance/relying_party/registration","draft":false,"unlisted":false,"editUrl":"https://github.com/YubicoLabs/passkey-workshop/tree/main/docs/docs/high_assurance/relying_party/registration.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Overview","permalink":"/passkey-workshop/docs/high_assurance/relying_party/overview"},"next":{"title":"Authentication","permalink":"/passkey-workshop/docs/high_assurance/relying_party/authentication"}}');var s=n(2467),r=n(8453);const a={sidebar_position:2},o="Registration",l={},c=[{value:"API",id:"api",level:2},{value:"Registration API",id:"registration-api",level:3},{value:"Credentials API",id:"credentials-api",level:3},{value:"Data Sources",id:"data-sources",level:2},{value:"Registration Flow",id:"registration-flow",level:2},{value:"Retrieving credentials",id:"retrieving-credentials",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"registration",children:"Registration"})}),"\n",(0,s.jsx)(t.p,{children:"This section covers registration for a high assurance scenario."}),"\n",(0,s.jsxs)(t.p,{children:["We already discussed attestation, the FIDO Metadata Service (MDS), and how to add attestation support to a Relying Party in the section on\n",(0,s.jsx)(t.a,{href:"/docs/category/attestation",children:"attestation"}),", so we will not repeat that here."]}),"\n",(0,s.jsxs)(t.p,{children:["This time however, we will use the fact that an authenticator is listed in MDS to determine whether or not the authenticator (and thus its stored passkeys) is to be considered High Assurance. For this, we will introduce a new property called ",(0,s.jsx)(t.code,{children:"isHighAssurance"})," that we will store for each credential registered."]}),"\n",(0,s.jsx)(t.h2,{id:"api",children:"API"}),"\n",(0,s.jsxs)(t.p,{children:["We begin by extending the passkey API that was described in ",(0,s.jsx)(t.a,{href:"/docs/relying-party/api-def",children:"API definition"}),".\nIf you deployed the banking application on ",(0,s.jsx)(t.code,{children:"localhost"}),", you can find its OpenAPI definition ",(0,s.jsx)(t.a,{href:"http://localhost:8080/swagger-ui/",children:"here"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"registration-api",children:"Registration API"}),"\n",(0,s.jsxs)(t.p,{children:["When sending a public-key attestation response using (",(0,s.jsx)(t.a,{href:"http://localhost:8080/swagger-ui/index.html#/v1/serverAuthenticatorAttestationResponse",children:(0,s.jsx)(t.code,{children:"/attestation/result"})}),"), the ",(0,s.jsx)(t.code,{children:"isHighAssurance"})," property is returned together with the other information stored in the repository:"]}),"\n",(0,s.jsx)(t.p,{children:"For instance:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "status": "created",\n  "credential": {\n    "id": "DthUeofXNtlMevkt_M7aiD3cm70...",\n    "type": "public-key",\n    "nickName": "YubiKey 5Ci",\n    "registrationTime": "2022-07-21T17:32:28Z",\n    "lastUsedTime": "2022-07-21T18:15:06Z",\n    "iconURI": "YubiKey 5Ci",\n    "isHighAssurance": true,\n    "state": "ENABLED"\n  }\n}\n'})}),"\n",(0,s.jsx)(t.h3,{id:"credentials-api",children:"Credentials API"}),"\n",(0,s.jsxs)(t.p,{children:["Similarly, when retrieving credential data for a specific user using\n(",(0,s.jsx)(t.a,{href:"http://localhost:8080/swagger-ui/index.html#/v1/userCredentialsByID",children:(0,s.jsx)(t.code,{children:"/user/credentials/{userName}"})}),"), the ",(0,s.jsx)(t.code,{children:"isHighAssurance"})," property is returned together with the other information stored in the repository. For instance:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "credentials": [\n    {\n      "id": "qn1QwPCX7kmwji1sVPnkB63Vaq29sc-uheZ_n_ejdMFs3pCzsKN5Dmlm9EVHfR6O",\n      "type": "public-key",\n      "nickName": "YubiKey 5 Series",\n      ...\n      "isHighAssurance": true,\n      "state": "ENABLED"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"data-sources",children:"Data Sources"}),"\n",(0,s.jsxs)(t.p,{children:["We continue with data sources, based on what we described earlier in ",(0,s.jsx)(t.a,{href:"/docs/relying-party/config-and-data",children:"Data sources and RP configurations"}),".\nWe need to change our credential repository to store whether or not a passkey is stored on a high assurance authenticator."]}),"\n",(0,s.jsxs)(t.p,{children:["Let's revisit the ",(0,s.jsx)(t.code,{children:"buildCredentialDBO"})," method used to package passkey information to store in our credential repository.\nEarlier, we added information like the name and the icon of the authenticator the passkey was stored on, when that authenticator was listed in MDS.\nWe will now simply add a boolean ",(0,s.jsx)(t.code,{children:"isHighAssurance"}),". We assign the value ",(0,s.jsx)(t.code,{children:"true"})," if we found a matching MDS entry when resolving an attestation, and assign the value ",(0,s.jsx)(t.code,{children:"false"})," otherwise:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'  private CredentialRegistration buildCredentialDBO(PublicKeyCredentialCreationOptions request,\n      RegistrationResult result) {\n    Optional<MetadataStatement> maybeMetadataEntry = resolveAttestation(result);\n\n    String credentialName;\n    String iconURI;\n    boolean isHighAssurance;\n\n    if (maybeMetadataEntry.isPresent()) {\n      credentialName = maybeMetadataEntry.get().getDescription().isPresent()\n          ? maybeMetadataEntry.get().getDescription().get()\n          : "My new passkey";\n      iconURI = maybeMetadataEntry.get().getIcon().isPresent()\n          ? maybeMetadataEntry.get().getIcon().get()\n          : null;\n      isHighAssurance = true;\n    } else {\n      credentialName = "My new passkey";\n      iconURI = null;\n      isHighAssurance = false;\n    }\n\n    return CredentialRegistration.builder()\n        .userIdentity(request.getUser())\n        .credentialNickname(Optional.of(credentialName))\n        .registrationTime(clock.instant())\n        .lastUpdateTime(clock.instant())\n        .lastUsedTime(clock.instant())\n        .credential(RegisteredCredential.builder()\n            .credentialId(result.getKeyId().getId())\n            .userHandle(request.getUser().getId())\n            .publicKeyCose(result.getPublicKeyCose())\n            .signatureCount(result.getSignatureCount())\n            .build())\n        .iconURI(Optional.ofNullable(iconURI))\n        .isHighAssurance(isHighAssurance)\n        .state(StateEnum.ENABLED)\n        .build();\n  }\n'})}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsxs)(t.p,{children:["The FIDO Metadata Service (MDS) is used to retrieve properties of a specific authenticator make and model.\nHere we assume these properties define the assurance level of credentials stored on such authenticators.\nThe ",(0,s.jsx)(t.code,{children:"isHighAssurance"})," property introduced here is a property of the credential (passkey)."]})}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsx)(t.p,{children:"The fact that an authenticator is listed in MDS doesn't automatically mean it is to be considered high assurance.\nThis depends on the local policy towards trusted authenticators.\nWe just define a very simply policy here that assumes passkeys stored on authenticators registered in MDS are to be considered high assurance.\nWhen implementing a high assurance scenario yourself, think carefully about what your policy should be like and implement that policy accordingly."})}),"\n",(0,s.jsxs)(t.p,{children:["Next, we'll add our new property to the ",(0,s.jsx)(t.code,{children:"CredentialRegistrationDBO"})," class that is used to store credentials in MySQL server:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'@Builder\n@Entity\n@NoArgsConstructor\n@AllArgsConstructor\n@Table(name = "credential_registrations")\npublic class CredentialRegistrationDBO {\n...\n\n  @Getter\n  @Column(columnDefinition = "boolean default false")\n  boolean isHighAssurance;\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["We will need to persist this information in the database by updating the table schema that is utilized for our credential repository (see ",(0,s.jsx)(t.a,{href:"/passkey-workshop/docs/architecture/relying-party",children:"our initial version"}),") accordingly:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE credential_registrations (\n    ...\n    is_high_assurance BOOL DEFAULT FALSE,\n    ...\n)\n"})}),"\n",(0,s.jsx)(t.h2,{id:"registration-flow",children:"Registration Flow"}),"\n",(0,s.jsxs)(t.p,{children:["Note that for adding the new ",(0,s.jsx)(t.code,{children:"isHighAssurance"})," property, we do not need to change our\n",(0,s.jsx)(t.a,{href:"/docs/relying-party/reg-flow#attestation-options-method",children:"Attestation options method"}),".\nThe only thing we need to change is the.\n",(0,s.jsx)(t.a,{href:"/docs/relying-party/reg-flow#attestation-result-method",children:"Attestation result method"})]}),"\n",(0,s.jsxs)(t.p,{children:["Similar to what was explained in ",(0,s.jsx)(t.a,{href:"/passkey-workshop/docs/relying-party/reg-flow",children:"registration flow"}),", the implementation of the ",(0,s.jsx)(t.code,{children:"/attestation/result"})," method simply returns the credentials properties, now including its high assurance status:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'  public AttestationResultResponse attestationResult(AttestationResultRequest response) throws Exception {\n\n        ...\n\n        return new AttestationResultResponse().status("created").credential(\n            UserCredentialsResponseCredentialsInner.builder()\n                .id(toStore.getCredential().getCredentialId().getBase64Url())\n                .type("public-key")\n                .nickName(toStore.getCredentialNickname().get())\n                .registrationTime(toStore.getRegistrationTime().atOffset(ZoneOffset.UTC))\n                .lastUsedTime(toStore.getLastUsedTime().atOffset(ZoneOffset.UTC))\n                .iconURI((toStore.getIconURI().isPresent() ? toStore.getIconURI().get() : null))\n                .isHighAssurance(toStore.isHighAssurance())\n                .state(toStore.getState().getValue())\n                .build());\n  }\n'})}),"\n",(0,s.jsx)(t.h2,{id:"retrieving-credentials",children:"Retrieving credentials"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"/user/credentials/{userName}"})," method is changed similarly:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",children:'  public UserCredentialsResponse getUserCredentials(String userName) throws Exception {\n\n    ...\n\n      List<UserCredentialsResponseCredentialsInner> credList = credentials.stream()\n          .map(cred -> UserCredentialsResponseCredentialsInner.builder()\n              .id(cred.getCredential().getCredentialId().getBase64Url())\n              .type("public-key")\n              .nickName(cred.getCredentialNickname().get())\n              .registrationTime(cred.getRegistrationTime().atOffset(ZoneOffset.UTC))\n              .lastUsedTime(cred.getLastUsedTime().atOffset(ZoneOffset.UTC))\n              .iconURI((cred.getIconURI().isPresent() ? cred.getIconURI().get() : null))\n              .isHighAssurance(cred.isHighAssurance())\n              .state(cred.getState().getValue())\n              .build())\n          .collect(Collectors.toList());\n    }\n'})}),"\n",(0,s.jsx)(t.p,{children:"Next, we'll have a closer look at authentication."})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var i=n(6540);const s={},r=i.createContext(s);function a(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);