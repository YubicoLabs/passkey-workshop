"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[972],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var s=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,s,o=function(e,t){if(null==e)return{};var n,s,o={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=s.createContext({}),p=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return s.createElement(l.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},h=s.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=a(e,["components","mdxType","originalType","parentName"]),d=p(n),h=o,m=d["".concat(l,".").concat(h)]||d[h]||c[h]||i;return n?s.createElement(m,r(r({ref:t},u),{},{components:n})):s.createElement(m,r({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=h;var a={};for(var l in t)hasOwnProperty.call(t,l)&&(a[l]=t[l]);a.originalType=e,a[d]="string"==typeof e?e:o,r[1]=a;for(var p=2;p<i;p++)r[p]=n[p];return s.createElement.apply(null,r)}return s.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2911:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>a,toc:()=>p});var s=n(7462),o=(n(7294),n(3905));const i={sidebar_position:4},r="Authentication flows",a={unversionedId:"relying-party/auth-flow",id:"relying-party/auth-flow",title:"Authentication flows",description:"This section will cover the authentication flows for logging in with a passkey.",source:"@site/docs/relying-party/auth-flow.md",sourceDirName:"relying-party",slug:"/relying-party/auth-flow",permalink:"/passkey-workshop/docs/relying-party/auth-flow",draft:!1,editUrl:"https://github.com/YubicoLabs/passkey-workshop/tree/main/docs/docs/relying-party/auth-flow.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Registration flows",permalink:"/passkey-workshop/docs/relying-party/reg-flow"},next:{title:"Web client",permalink:"/passkey-workshop/docs/category/web-client"}},l={},p=[{value:"Flow overview",id:"flow-overview",level:2},{value:"Assertion options method",id:"assertion-options-method",level:2},{value:"API request and response schema",id:"api-request-and-response-schema",level:3},{value:"Request",id:"request",level:4},{value:"Discoverable credential flow",id:"discoverable-credential-flow",level:5},{value:"Non-discoverable credential flow",id:"non-discoverable-credential-flow",level:5},{value:"Response",id:"response",level:4},{value:"Discoverable credential flow",id:"discoverable-credential-flow-1",level:5},{value:"Non-discoverable credential flow",id:"non-discoverable-credential-flow-1",level:5},{value:"Implementation",id:"implementation",level:3},{value:"Assertion result method",id:"assertion-result-method",level:2},{value:"API request and response schema",id:"api-request-and-response-schema-1",level:3},{value:"Request",id:"request-1",level:4},{value:"Response",id:"response-1",level:4},{value:"Implementation",id:"implementation-1",level:3}],u={toc:p},d="wrapper";function c(e){let{components:t,...i}=e;return(0,o.kt)(d,(0,s.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"authentication-flows"},"Authentication flows"),(0,o.kt)("p",null,"This section will cover the authentication flows for logging in with a passkey."),(0,o.kt)("p",null,"By the end of this section you will understand how to use and implement both of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/options")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/result")," methods (as defined by our ",(0,o.kt)("a",{parentName:"p",href:"relying-party/api-def"},"API"),")"),(0,o.kt)("h2",{id:"flow-overview"},"Flow overview"),(0,o.kt)("p",null,"The diagram below demonstrates how the relying party works with the client, and authenticator to authenticate with a passkey. When interacting with the relying party, the client will leverage both of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion")," methods."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Docusaurus logo",src:n(5699).Z,width:"1095",height:"1334"})),(0,o.kt)("p",null,"The first call (",(0,o.kt)("a",{parentName:"p",href:"http://localhost:8080/swagger-ui/index.html#/v1/serverPublicKeyCredentialCreationOptionsRequest"},(0,o.kt)("inlineCode",{parentName:"a"},"/attestation/options")),") is used to receive an object that includes the options/configurations that should be used when creating a new credential."),(0,o.kt)("p",null,"The second call (",(0,o.kt)("a",{parentName:"p",href:"http://localhost:8080/swagger-ui/index.html#/v1/serverAuthenticatorAttestationResponse"},(0,o.kt)("inlineCode",{parentName:"a"},"/attestation/result")),") is used to send the newly created passkey to be stored in the relying party."),(0,o.kt)("h2",{id:"assertion-options-method"},"Assertion options method"),(0,o.kt)("p",null,"This section will outline the assertion options method as well as provide a sample implementation in Java using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Yubico/java-webauthn-server"},"java-webauthn-server library"),"."),(0,o.kt)("h3",{id:"api-request-and-response-schema"},"API request and response schema"),(0,o.kt)("h4",{id:"request"},"Request"),(0,o.kt)("p",null,"Below is the request body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/options")," method"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": "user@acme.com"\n}\n')),(0,o.kt)("p",null,"In this case, we are only signaling to the relying party the user which we are trying to authenticate. This method is implemented in a way that will support ",(0,o.kt)("strong",{parentName:"p"},"BOTH")," discoverable and non-discoverable credential flows. For the sake of this workshop, our focus will be on the discoverable credential flow, but we will outline how the non-discoverable credential flow is handled."),(0,o.kt)("h5",{id:"discoverable-credential-flow"},"Discoverable credential flow"),(0,o.kt)("p",null,"As you may recall from the fundamentals section, a WebAuthn credential must be discoverable in order to be a passkey. A discoverable credential refers to the ability for a relying party to attempt to utilize a credential on an authenticator without the user providing a user handle. This means that in our API we will signal to the RP that we wish to use a discoverable credential flow by passing in an empty username."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": ""\n}\n')),(0,o.kt)("h5",{id:"non-discoverable-credential-flow"},"Non-discoverable credential flow"),(0,o.kt)("p",null,"In order to trigger the use of a non-discoverable credential flow, you will include the ",(0,o.kt)("inlineCode",{parentName:"p"},"userName")," associated to the user who is trying to authenticate."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": "user@acme.com"\n}\n')),(0,o.kt)("h4",{id:"response"},"Response"),(0,o.kt)("p",null,"As indicated in the previous section, this method will include two different types of responses. In the WebAuthn specification, this object is referred to as the ",(0,o.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/webauthn-2/#dictionary-assertion-options"},"PublicKeyCredentialRequestOptions"),", but will contain extra data depending on the flow being used."),(0,o.kt)("h5",{id:"discoverable-credential-flow-1"},"Discoverable credential flow"),(0,o.kt)("p",null,"Below is the response body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/attestation/options")," method for a discoverable credential flow"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requestId": "WlEPtNrJps-E03p_rwfXqASFkbrQ6Ml3Oy031JW4TYo",\n  "publicKey": {\n    "challenge": "NGc3jpB4Q-VnOmbhFBnDAczlYPT4soKA7xviGeJmDhc",\n    "timeout": 180000,\n    "rpId": "localhost",\n    "userVerification": "preferred"\n  }\n}\n')),(0,o.kt)("h5",{id:"non-discoverable-credential-flow-1"},"Non-discoverable credential flow"),(0,o.kt)("p",null,"Below is the response body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/attestation/options")," method for a non-discoverable credential flow"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requestId": "B-J4odOi9vcV-4TN_gpokEb1f1EI...",\n  "publicKey": {\n    "challenge": "m7xl_TkTcCe0WcXI2M-4ro9vJAuwcj4m",\n    "timeout": 20000,\n    "rpId": "localhost",\n    "allowCredentials": [\n      {\n        "id": "opQf1WmYAa5aupUKJIQp",\n        "type": "public-key"\n      }\n    ],\n    "userVerification": "preferred"\n  }\n}\n')),(0,o.kt)("p",null,"Note the major difference in both responses is the inclusion of the ",(0,o.kt)("inlineCode",{parentName:"p"},"allowCredentials")," property, which ",(0,o.kt)("strong",{parentName:"p"},"only exists for non-discoverable credential flows"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," field in an ",(0,o.kt)("inlineCode",{parentName:"p"},"allowCredentials")," entry relates to the credential ID of a WebAuthn credential that belongs to the user identified in the request body."),(0,o.kt)("p",null,"This means that the WebAuthn ceremony will only succeed if the user can demonstrate ownership of one of the credentials provided in the ",(0,o.kt)("inlineCode",{parentName:"p"},"allowedCredentials")," list. The credential present in this list should be all of the credentials belonging to that user."),(0,o.kt)("p",null,"The ",(0,o.kt)("strong",{parentName:"p"},"exclusion")," of this list will allow the user to select a passkey (discoverable credential) on their authenticator, if one exists."),(0,o.kt)("p",null,"The key difference is that the non-discoverable flow is looking for a specific set of credentials, while the discoverable flow is looking for the user to select one of their credentials."),(0,o.kt)("admonition",{title:"passkeys can be used in non-discoverable credential flows",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Just because a passkey is a discoverable credential, does not mean that it cannot be used in a non-discoverable credential flow. Regardless of credential type, the RP will have the credential ID, and can be passed to the client if requested by the flow."),(0,o.kt)("p",{parentName:"admonition"},"With that said, non-discoverable credentials cannot be leveraged in the discoverable credential flow. So if you have users who rely on the use of non-discoverable credentials, then ensure that you provide them with the option to utilize a non-discoverable credential flow")),(0,o.kt)("h3",{id:"implementation"},"Implementation"),(0,o.kt)("p",null,"Below is a sample implementation of the /attestation/options method. Note that ",(0,o.kt)("inlineCode",{parentName:"p"},"request")," should correlate to the request body mentioned in the previous section, and ",(0,o.kt)("inlineCode",{parentName:"p"},"response")," should correlate to the request response mentioned in the previous section."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public AssertionOptionsResponse assertionOptions(AssertionOptionsRequest request) throws Exception {\n  try {\n    /**\n     * Begin to build the PKC options\n     */\n\n    StartAssertionOptionsBuilder optionsBuilder = StartAssertionOptions.builder();\n\n    // Configure the options with default values\n    optionsBuilder.userVerification(UserVerificationRequirement.PREFERRED).timeout(180000);\n\n    /**\n     * Check if the user has a credential stored in the DB\n     */\n    Collection<CredentialRegistration> credentials = relyingPartyInstance.getStorageInstance().getCredentialStorage()\n        .getRegistrationsByUsername(request.getUserName());\n\n    /**\n     * If the user has no credentials, or the username was blank, then\n     * do not attempt to attach the allowCredentials property\n     */\n    if (credentials.size() != 0 || request.getUserName() != "") {\n      /*\n        * To preserve privacy, if a request was made with a non-existent username, or\n        * missing a username\n        * then a discoverable credentials flow will be enabled\n        */\n\n      optionsBuilder.username(request.getUserName());\n    }\n    AssertionRequest pkc = relyingPartyInstance.getRelyingParty()\n        .startAssertion(optionsBuilder.build());\n\n    ByteArray requestId = generateRandomByteArray(32);\n\n    /**\n     * Helper method to translate the pkc object into\n     * strings for use in the JSON request\n     */\n    AssertionOptionsResponse response = AssertionOptionsResponseConverter\n        .PKCtoResponse(pkc.getPublicKeyCredentialRequestOptions(), requestId);\n\n    AssertionRequestStorage.insert(pkc, requestId.getBase64Url());\n\n    return response;\n  } catch (Exception e) {\n    e.printStackTrace();\n    throw new Exception("There was an issue while generating AssertionOptions: " + e.getMessage());\n  }\n}\n')),(0,o.kt)("h2",{id:"assertion-result-method"},"Assertion result method"),(0,o.kt)("p",null,"This section will outline the assertion result method as well as provide a sample implementation in Java using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Yubico/java-webauthn-server"},"java-webauthn-server library"),"."),(0,o.kt)("h3",{id:"api-request-and-response-schema-1"},"API request and response schema"),(0,o.kt)("h4",{id:"request-1"},"Request"),(0,o.kt)("p",null,"Below is the request body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/result")," method"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requestId": "B-J4odOi9vcV-4TN_gpokEb1f1EI...",\n  "assertionResult": {\n    "id": "LFdoCFJTyB82ZzSJUHc-c72yraRc_1mPvG",\n    "response": {\n      "authenticatorData": "SZYN5Gh0NBcPZHZgW4_krrmihjzzuoMdl2MBAAAAAA...",\n      "signature": "ME8fLjd5y6TUOLWt5l9DQIhANiYig9newAJZYTzG1i5lwP",\n      "userHandle": "string",\n      "clientDataJSON": "eyJjaGFTBrTmM4uIjoiaHR0cDovL2xvY2FsF1dGhuLmdldCJ9..."\n    },\n    "type": "public-key",\n    "clientExtensionResults": {}\n  }\n}\n')),(0,o.kt)("p",null,"These properties will include the result of the ",(0,o.kt)("inlineCode",{parentName:"p"},"navigator.credentials.get")," method, along with the requestId, that was included in the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/options")," response."),(0,o.kt)("p",null,"In most cases, you will directly pass the result of the ",(0,o.kt)("inlineCode",{parentName:"p"},"navigator.credentials.get")," method into the ",(0,o.kt)("inlineCode",{parentName:"p"},"assertionResult")," property."),(0,o.kt)("h4",{id:"response-1"},"Response"),(0,o.kt)("p",null,"Below is the response body of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/assertion/result")," method"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "status": "ok"\n}\n')),(0,o.kt)("p",null,"In this case, the result is simple. We include a property, ",(0,o.kt)("inlineCode",{parentName:"p"},"status"),", that denotes the result of the authentication ceremony. If successful, then the status should be returned as ",(0,o.kt)("inlineCode",{parentName:"p"},"ok"),", signaling to the caller that the authentication ceremony was successful. Otherwise, an error occurred and should be conveyed to the user."),(0,o.kt)("h3",{id:"implementation-1"},"Implementation"),(0,o.kt)("p",null,"Below is a sample implementation of the /assertion/result method. Note that ",(0,o.kt)("inlineCode",{parentName:"p"},"request")," should correlate to the request body mentioned in the previous section, and ",(0,o.kt)("inlineCode",{parentName:"p"},"response")," should correlate to the request response mentioned in the previous section."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public AssertionResultResponse assertionResponse(AssertionResultRequest response) throws Exception {\n  try {\n    /**\n     * Check for assertion request\n     */\n    Optional<AssertionOptions> maybeOptions = AssertionRequestStorage.getIfPresent(response.getRequestId());\n\n    AssertionOptions options;\n\n    if (maybeOptions.isPresent()) {\n      options = maybeOptions.get();\n    } else {\n      throw new Exception("Registration request not present");\n    }\n\n    /**\n     * Check if the request is still active\n     */\n    if (!options.getIsActive()) {\n      // Not active, return error\n      throw new Exception("Registration request is no longer active");\n    } else {\n      AssertionRequestStorage.invalidate(response.getRequestId());\n    }\n\n    /**\n     * Build assertion request\n     */\n    AssertionRequestBuilder requestBuilder = AssertionRequest.builder()\n        .publicKeyCredentialRequestOptions(options.getAssertionRequest().getPublicKeyCredentialRequestOptions());\n\n    // Check if a username was present in the request\n    if (options.getAssertionRequest().getUsername().isPresent()) {\n      requestBuilder.username(options.getAssertionRequest().getUsername().get());\n    }\n\n    AssertionResult result = relyingPartyInstance.getRelyingParty().finishAssertion(FinishAssertionOptions.builder()\n        .request(requestBuilder.build())\n        .response(parseAssertionResponse(response.getAssertionResult()))\n        .build());\n\n    if (result.isSuccess()) {\n      return AssertionResultResponse.builder().status("ok").build();\n    } else {\n      throw new Exception("Your assertion failed for an unknown reason");\n    }\n  } catch (Exception e) {\n    e.printStackTrace();\n    throw new Exception("There was an issue finalizing your assertion your credential: " + e.getMessage());\n  }\n}\n')))}c.isMDXComponent=!0},5699:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/auth-flow-1aca9e2ec4f1a0e76f94b2851166dae8.jpg"}}]);